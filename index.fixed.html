<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>××¢×¨×›×ª × ×™×”×•×œ ×¡×•×¤×¨××¨×§×˜</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; direction: rtl; }
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    .header { text-align: center; margin-bottom: 30px; background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); padding: 30px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.2); box-shadow: 0 8px 32px 0 rgba(31,38,135,0.37); }
    .header h1 { color: #fff; font-size: 3rem; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
    .header p { color: rgba(255,255,255,0.9); font-size: 1.2rem; }
    .main-nav { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .nav-card { background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); border-radius: 15px; padding: 25px; text-align: center; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 8px 32px 0 rgba(31,38,135,0.37); }
    .nav-card:hover { transform: translateY(-5px); background: rgba(255,255,255,0.25); box-shadow: 0 12px 40px 0 rgba(31,38,135,0.5); }
    .nav-card h3 { color: #fff; font-size: 1.8rem; margin-bottom: 10px; }
    .nav-card p { color: rgba(255,255,255,0.8); font-size: 1rem; }
    .icon { font-size: 3rem; margin-bottom: 15px; display: block; }
    .content-area { background: rgba(255,255,255,0.95); border-radius: 15px; padding: 30px; margin-top: 20px; box-shadow: 0 8px 32px 0 rgba(31,38,135,0.37); display: none; }
    .content-area.active { display: block; animation: fadeIn 0.5s ease; }
    @keyframes fadeIn { from {opacity:0; transform: translateY(20px);} to {opacity:1; transform: translateY(0);} }
    .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 2px solid #eee; }
    .section-title { color: #333; font-size: 2rem; }
    .back-btn { background: #6c5ce7; color: #fff; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 1rem; transition: background 0.3s; }
    .back-btn:hover { background: #5a4fcf; }
    .form-container { background: #f8f9fa; padding: 25px; border-radius: 10px; margin-bottom: 25px; border: 2px solid #e9ecef; }
    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; margin-bottom: 8px; font-weight: bold; color: #333; }
    .form-group input, .form-group select { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem; transition: border-color 0.3s; }
    .form-group input:focus, .form-group select:focus { outline: none; border-color: #6c5ce7; box-shadow: 0 0 0 3px rgba(108,92,231,0.1); }
    .btn { background: #00b894; color: #fff; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; font-size: 1rem; margin: 5px; transition: all 0.3s; }
    .btn:hover { background: #00a085; transform: translateY(-2px); }
    .btn-danger { background: #e17055; }
    .btn-danger:hover { background: #d63031; }
    .btn-info { background: #74b9ff; }
    .btn-info:hover { background: #0984e3; }
    .data-table { width: 100%; border-collapse: collapse; margin-top: 20px; background: #fff; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .data-table th, .data-table td { padding: 15px; text-align: right; border-bottom: 1px solid #eee; }
    .data-table th { background: #6c5ce7; color: #fff; font-weight: bold; }
    .data-table tr:hover { background: #f8f9fa; }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin: 20px 0; }
    .stat-card { background: #fff; padding: 25px; border-radius: 10px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: 2px solid #e9ecef; }
    .stat-number { font-size: 2.5rem; font-weight: bold; color: #6c5ce7; margin-bottom: 10px; }
    .stat-label { color: #666; font-size: 1.1rem; }
    .alert { padding: 15px; margin: 10px 0; border-radius: 8px; border: 1px solid transparent; }
    .alert-success { background: #d4edda; color: #155724; border-color: #c3e6cb; }
    .alert-error { background: #f8d7da; color: #721c24; border-color: #f5c6cb; }
    .order-items { background: #f8f9fa; border: 2px solid #dee2e6; border-radius: 8px; padding: 20px; margin: 15px 0; }
    .item-row { display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 15px; align-items: center; padding: 10px; border-bottom: 1px solid #dee2e6; }
    .item-row:last-child { border-bottom: none; }
    .remove-item-btn { background: #e17055; color: #fff; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-size: 0.9rem; }
    .loading { text-align: center; padding: 40px; color: #666; font-size: 1.2rem; }
    .empty-state { text-align: center; padding: 60px; color: #666; }
    .empty-state h3 { margin-bottom: 15px; font-size: 1.5rem; }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1>ğŸ›’ ×¡×•×¤×¨××¨×§×˜ ×¤××•×–×™ ×•××•×¢××“</h1>
    </div>

    <!-- Main Navigation -->
    <div id="main-menu" class="main-nav">
      <div class="nav-card" onclick="showSection('customers')">
        <span class="icon">ğŸ‘¥</span>
        <h3>×œ×§×•×—×•×ª</h3>
        <p>× ×™×”×•×œ ×¤×¨×˜×™ ×œ×§×•×—×•×ª, ×”×•×¡×¤×”, ×¢×¨×™×›×” ×•××—×™×§×”</p>
      </div>
      <div class="nav-card" onclick="showSection('products')">
        <span class="icon">ğŸ“¦</span>
        <h3>××•×¦×¨×™×</h3>
        <p>× ×™×”×•×œ ××œ××™ ×”××•×¦×¨×™×, ××—×™×¨×™× ×•×§×˜×’×•×¨×™×•×ª</p>
      </div>
      <div class="nav-card" onclick="showSection('orders')">
        <span class="icon">ğŸ›ï¸</span>
        <h3>×”×–×× ×•×ª</h3>
        <p>× ×™×”×•×œ ×”×–×× ×•×ª, ××¢×§×‘ ×¡×˜×˜×•×¡ ×•×¨×©×™××ª ×¨×›×™×©×•×ª</p>
      </div>
      <div class="nav-card" onclick="showSection('analytics')">
        <span class="icon">ğŸ“Š</span>
        <h3>×“×•×—×•×ª ×•× ×ª×•× ×™×</h3>
        <p>×¡×˜×˜×™×¡×˜×™×§×•×ª ××›×™×¨×•×ª, ×œ×§×•×—×•×ª ××•×‘×™×œ×™× ×•×¢×•×“</p>
      </div>
    </div>

    <!-- Customers Section -->
    <div id="customers" class="content-area">
      <div class="section-header">
        <h2 class="section-title">× ×™×”×•×œ ×œ×§×•×—×•×ª</h2>
        <button class="back-btn" onclick="showMainMenu()">×—×–×¨×” ×œ×ª×¤×¨×™×˜ ×”×¨××©×™</button>
      </div>

      <div class="form-container">
        <h3>×”×•×¡×¤×ª ×œ×§×•×— ×—×“×©</h3>
        <form id="customer-form">
          <div class="form-group">
            <label for="customer-id">××–×”×” ×œ×§×•×—:</label>
            <input type="text" id="customer-id" required />
          </div>
          <div class="form-group">
            <label for="customer-name">×©× ××œ×:</label>
            <input type="text" id="customer-name" required />
          </div>
          <div class="form-group">
            <label for="customer-phone">×˜×œ×¤×•×Ÿ:</label>
            <input type="tel" id="customer-phone" required />
          </div>
          <div class="form-group">
            <label for="customer-email">××™××™×™×œ:</label>
            <input type="email" id="customer-email" required />
          </div>
          <button type="submit" class="btn">×”×•×¡×£ ×œ×§×•×—</button>
        </form>
      </div>

      <div class="form-container">
        <h3>×—×™×¤×•×© ×œ×§×•×—</h3>
        <div class="form-group">
          <input type="text" id="search-customer" placeholder="×”×›× ×¡ ××–×”×” ×œ×§×•×— ×œ×—×™×¤×•×©..." />
          <button class="btn btn-info" onclick="searchCustomer()">×—×¤×©</button>
          <button class="btn" onclick="loadAllCustomers()">×”×¦×’ ××ª ×›×œ ×”×œ×§×•×—×•×ª</button>
        </div>
      </div>

      <div id="customers-list"></div>
    </div>

    <!-- Products Section -->
    <div id="products" class="content-area">
      <div class="section-header">
        <h2 class="section-title">× ×™×”×•×œ ××•×¦×¨×™×</h2>
        <button class="back-btn" onclick="showMainMenu()">×—×–×¨×” ×œ×ª×¤×¨×™×˜ ×”×¨××©×™</button>
      </div>

      <div class="form-container">
        <h3>×”×•×¡×¤×ª ××•×¦×¨ ×—×“×©</h3>
        <form id="product-form">
          <div class="form-group">
            <label for="product-id">××–×”×” ××•×¦×¨:</label>
            <input type="text" id="product-id" required />
          </div>
          <div class="form-group">
            <label for="product-name">×©× ×”××•×¦×¨:</label>
            <input type="text" id="product-name" required />
          </div>
          <div class="form-group">
            <label for="product-category">×§×˜×’×•×¨×™×”:</label>
            <input type="text" id="product-category" required />
          </div>
          <div class="form-group">
            <label for="product-price">××—×™×¨ (â‚ª):</label>
            <input type="number" id="product-price" step="0.01" min="0" required />
          </div>
          <button type="submit" class="btn">×”×•×¡×£ ××•×¦×¨</button>
        </form>
      </div>

      <div class="form-container">
        <h3>×—×™×¤×•×© ××•×¦×¨</h3>
        <div class="form-group">
          <input type="text" id="search-product" placeholder="×”×›× ×¡ ××–×”×” ××•×¦×¨ ×œ×—×™×¤×•×©..." />
          <button class="btn btn-info" onclick="searchProduct()">×—×¤×©</button>
          <button class="btn" onclick="loadAllProducts()">×”×¦×’ ××ª ×›×œ ×”××•×¦×¨×™×</button>
        </div>
      </div>

      <div id="products-list"></div>
    </div>

    <!-- Orders Section -->
    <div id="orders" class="content-area">
      <div class="section-header">
        <h2 class="section-title">× ×™×”×•×œ ×”×–×× ×•×ª</h2>
        <button class="back-btn" onclick="showMainMenu()">×—×–×¨×” ×œ×ª×¤×¨×™×˜ ×”×¨××©×™</button>
      </div>

      <div class="form-container">
        <h3>×™×¦×™×¨×ª ×”×–×× ×” ×—×“×©×”</h3>
        <form id="order-form">
          <div class="form-group">
            <label for="order-id">××–×”×” ×”×–×× ×”:</label>
            <input type="text" id="order-id" required />
          </div>
          <div class="form-group">
            <label for="order-customer-id">××–×”×” ×œ×§×•×—:</label>
            <input type="text" id="order-customer-id" required />
          </div>

          <div class="order-items">
            <h4>×¤×¨×™×˜×™ ×”×”×–×× ×”</h4>
            <div id="order-items-container">
              <div class="item-row">
                <input type="text" placeholder="××–×”×” ××•×¦×¨" class="product-id-input" required />
                <input type="number" placeholder="×›××•×ª" class="quantity-input" min="1" value="1" required />
                <span class="price-display">××—×™×¨: -</span>
                <button type="button" class="remove-item-btn" onclick="removeOrderItem(this)">×”×¡×¨</button>
              </div>
            </div>
            <button type="button" class="btn btn-info" onclick="addOrderItem()">×”×•×¡×£ ××•×¦×¨ × ×•×¡×£</button>
          </div>

          <button type="submit" class="btn">×¦×•×¨ ×”×–×× ×”</button>
        </form>
      </div>

      <div class="form-container">
        <h3>×—×™×¤×•×© ×”×–×× ×•×ª</h3>
        <div class="form-group">
          <input type="text" id="search-order" placeholder="×”×›× ×¡ ××–×”×” ×”×–×× ×” ×œ×—×™×¤×•×©..." />
          <button class="btn btn-info" onclick="searchOrder()">×—×¤×© ×”×–×× ×”</button>
        </div>
        <div class="form-group">
          <input type="text" id="search-customer-orders" placeholder="×”×›× ×¡ ××–×”×” ×œ×§×•×— ×œ×—×™×¤×•×© ×”×–×× ×•×ª..." />
          <button class="btn btn-info" onclick="searchCustomerOrders()">×—×¤×© ×”×–×× ×•×ª ×œ×§×•×—</button>
        </div>
      </div>

      <div id="orders-list"></div>
    </div>

    <!-- Analytics Section -->
    <div id="analytics" class="content-area">
      <div class="section-header">
        <h2 class="section-title">×“×•×—×•×ª ×•× ×ª×•× ×™×</h2>
        <button class="back-btn" onclick="showMainMenu()">×—×–×¨×” ×œ×ª×¤×¨×™×˜ ×”×¨××©×™</button>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div id="total-revenue" class="stat-number">0 â‚ª</div>
          <div class="stat-label">×”×›× ×¡×•×ª ×›×•×œ×œ×•×ª</div>
        </div>
        <div class="stat-card">
          <div id="total-customers" class="stat-number">0</div>
          <div class="stat-label">××¡×¤×¨ ×œ×§×•×—×•×ª</div>
        </div>
        <div class="stat-card">
          <div id="total-products" class="stat-number">0</div>
          <div class="stat-label">××¡×¤×¨ ××•×¦×¨×™×</div>
        </div>
      </div>

      <div class="form-container">
        <h3>×œ×§×•×—×•×ª ××•×‘×™×œ×™×</h3>
        <div class="form-group">
          <label for="top-customers-limit">×›××” ×œ×§×•×—×•×ª ×œ×”×¦×™×’:</label>
          <input type="number" id="top-customers-limit" value="5" min="1" max="20" />
          <button class="btn" onclick="loadTopCustomers()">×”×¦×’ ×œ×§×•×—×•×ª ××•×‘×™×œ×™×</button>
        </div>
        <div id="top-customers-list"></div>
      </div>

      <div class="form-container">
        <h3>×”××•×¦×¨ ×”× ××›×¨ ×‘×™×•×ª×¨</h3>
        <button class="btn" onclick="loadTopProduct()">×”×¦×’ ××•×¦×¨ ××•×‘×™×œ</button>
        <div id="top-product-info"></div>
      </div>
    </div>
  </div>

  <script>
    // API Configuration
    const API_BASE_URL = 'http://localhost:5000/api';

    // Global state
    let customers = [];
    let products = [];
    let orders = [];

    // Generic API helper
    async function apiCall(endpoint, options = {}) {
      try {
        const response = await fetch(`${API_BASE_URL}${endpoint}`, {
          headers: { 'Content-Type': 'application/json', ...(options.headers || {}) },
          ...options,
        });
        const data = await response.json();
        if (data.success === false) throw new Error(data.error || '×©×’×™××” ×œ× ×™×“×•×¢×”');
        return data;
      } catch (error) {
        console.error('API Error:', error);
        if (error.name === 'TypeError') {
          throw new Error('×œ× × ×™×ª×Ÿ ×œ×”×ª×—×‘×¨ ×œ×©×¨×ª. ×‘×“×•×§ ×©×”×©×¨×ª Flask ×¤×•×¢×œ ×¢×œ ×¤×•×¨×˜ 5000');
        }
        throw error;
      }
    }

    // Navigation
    function showMainMenu() {
      document.getElementById('main-menu').style.display = 'grid';
      document.querySelectorAll('.content-area').forEach(area => area.classList.remove('active'));
    }
    function showSection(sectionName) {
      document.getElementById('main-menu').style.display = 'none';
      document.querySelectorAll('.content-area').forEach(area => area.classList.remove('active'));
      document.getElementById(sectionName).classList.add('active');
      if (sectionName === 'customers') loadAllCustomers();
      if (sectionName === 'products') loadAllProducts();
      if (sectionName === 'analytics') loadAnalytics();
    }

    // Alerts
    function showAlert(message, type = 'success') {
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type}`;
      alertDiv.textContent = message;
      const activeArea = document.querySelector('.content-area.active');
      if (activeArea) {
        activeArea.insertBefore(alertDiv, activeArea.firstChild.nextSibling);
        setTimeout(() => alertDiv.remove(), 5000);
      }
    }

    // ---------------- Customers ----------------
    document.getElementById('customer-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      const customerData = {
        customer_id: document.getElementById('customer-id').value,
        name: document.getElementById('customer-name').value,
        phone: document.getElementById('customer-phone').value,
        email: document.getElementById('customer-email').value,
      };
      try {
        await apiCall('/customers', { method: 'POST', body: JSON.stringify(customerData) });
        showAlert('×œ×§×•×— × ×•×¡×£ ×‘×”×¦×œ×—×”');
        this.reset();
        await loadAllCustomers();
      } catch (err) { showAlert(err.message, 'error'); }
    });

    async function loadAllCustomers() {
      try {
        const res = await apiCall('/customers');
        customers = res.data || res;
        displayCustomers(customers);
      } catch (err) {
        showAlert(err.message, 'error');
        document.getElementById('customers-list').innerHTML =
          '<div class="empty-state"><h3>×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×</h3><p>×‘×“×•×§ ×©×”×©×¨×ª Flask ×¤×•×¢×œ</p></div>';
      }
    }

    function displayCustomers(list) {
      const container = document.getElementById('customers-list');
      if (!list || list.length === 0) {
        container.innerHTML = '<div class="empty-state"><h3>××™×Ÿ ×œ×§×•×—×•×ª ×‘××¢×¨×›×ª</h3><p>×”×•×¡×£ ×œ×§×•×— ×¨××©×•×Ÿ ×›×“×™ ×œ×”×ª×—×™×œ</p></div>';
        return;
      }
      let html = '<table class="data-table"><thead><tr><th>××–×”×”</th><th>×©×</th><th>×˜×œ×¤×•×Ÿ</th><th>××™××™×™×œ</th><th>×¤×¢×•×œ×•×ª</th></tr></thead><tbody>';
      list.forEach(c => {
        html += `
          <tr>
            <td>${c._id}</td>
            <td>${c.name}</td>
            <td>${c.phone}</td>
            <td>${c.email}</td>
            <td>
              <button class="btn btn-info" onclick="editCustomer('${c._id}')">×¢×¨×™×›×”</button>
              <button class="btn btn-danger" onclick="deleteCustomer('${c._id}')">××—×™×§×”</button>
            </td>
          </tr>`;
      });
      html += '</tbody></table>';
      container.innerHTML = html;
    }

    async function searchCustomer() {
      const id = document.getElementById('search-customer').value;
      if (!id) return;
      try {
        const res = await apiCall(`/customers/${id}`);
        displayCustomers([res.data]);
      } catch { showAlert('×œ×§×•×— ×œ× × ××¦×', 'error'); }
    }

    async function editCustomer(id) {
      try {
        const { data } = await apiCall(`/customers/${id}`);
        const name = prompt('×©× ×—×“×©:', data.name);
        const phone = prompt('×˜×œ×¤×•×Ÿ ×—×“×©:', data.phone);
        const email = prompt('××™××™×™×œ ×—×“×©:', data.email);
        if (name && phone && email) {
          await apiCall(`/customers/${id}`, { method: 'PUT', body: JSON.stringify({ name, phone, email }) });
          showAlert('×œ×§×•×— ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”');
          await loadAllCustomers();
        }
      } catch (e) { showAlert(e.message, 'error'); }
    }

    async function deleteCustomer(id) {
      if (!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ×œ×§×•×— ×–×”?')) return;
      try {
        await apiCall(`/customers/${id}`, { method: 'DELETE' });
        showAlert('×œ×§×•×— × ××—×§ ×‘×”×¦×œ×—×”');
        await loadAllCustomers();
      } catch (e) { showAlert(e.message, 'error'); }
    }

    // ---------------- Products ----------------
    document.getElementById('product-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      const product = {
        product_id: document.getElementById('product-id').value,
        name: document.getElementById('product-name').value,
        category: document.getElementById('product-category').value,
        price: parseFloat(document.getElementById('product-price').value),
      };
      try {
        await apiCall('/products', { method: 'POST', body: JSON.stringify(product) });
        showAlert('××•×¦×¨ × ×•×¡×£ ×‘×”×¦×œ×—×”');
        this.reset();
        await loadAllProducts();
      } catch (e) { showAlert(e.message, 'error'); }
    });

    async function loadAllProducts() {
      try {
        const res = await apiCall('/products');
        products = res.data || res;
        displayProducts(products);
      } catch (e) {
        showAlert(e.message, 'error');
        document.getElementById('products-list').innerHTML =
          '<div class="empty-state"><h3>×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×</h3><p>×‘×“×•×§ ×©×”×©×¨×ª Flask ×¤×•×¢×œ</p></div>';
      }
    }

    function displayProducts(list) {
      const container = document.getElementById('products-list');
      if (!list || list.length === 0) {
        container.innerHTML = '<div class="empty-state"><h3>××™×Ÿ ××•×¦×¨×™× ×‘××¢×¨×›×ª</h3><p>×”×•×¡×£ ××•×¦×¨ ×¨××©×•×Ÿ ×›×“×™ ×œ×”×ª×—×™×œ</p></div>';
        return;
      }
      let html = '<table class="data-table"><thead><tr><th>××–×”×”</th><th>×©×</th><th>×§×˜×’×•×¨×™×”</th><th>××—×™×¨</th><th>×¤×¢×•×œ×•×ª</th></tr></thead><tbody>';
      list.forEach(p => {
        html += `
          <tr>
            <td>${p._id}</td>
            <td>${p.name}</td>
            <td>${p.category}</td>
            <td>â‚ª${p.price}</td>
            <td>
              <button class="btn btn-info" onclick="editProduct('${p._id}')">×¢×¨×™×›×”</button>
              <button class="btn btn-danger" onclick="deleteProduct('${p._id}')">××—×™×§×”</button>
            </td>
          </tr>`;
      });
      html += '</tbody></table>';
      container.innerHTML = html;
    }

    async function searchProduct() {
      const id = document.getElementById('search-product').value;
      if (!id) return;
      try {
        const res = await apiCall(`/products/${id}`);
        displayProducts([res.data]);
      } catch { showAlert('××•×¦×¨ ×œ× × ××¦×', 'error'); }
    }

    async function editProduct(id) {
      try {
        const { data } = await apiCall(`/products/${id}`);
        const name = prompt('×©× ×—×“×©:', data.name);
        const category = prompt('×§×˜×’×•×¨×™×” ×—×“×©×”:', data.category);
        const price = prompt('××—×™×¨ ×—×“×©:', data.price);
        if (name && category && price && !isNaN(price)) {
          await apiCall(`/products/${id}`, { method: 'PUT', body: JSON.stringify({ name, category, price: parseFloat(price) }) });
          showAlert('××•×¦×¨ ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”');
          await loadAllProducts();
        }
      } catch (e) { showAlert(e.message, 'error'); }
    }

    async function deleteProduct(id) {
      if (!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××•×¦×¨ ×–×”?')) return;
      try {
        await apiCall(`/products/${id}`, { method: 'DELETE' });
        showAlert('××•×¦×¨ × ××—×§ ×‘×”×¦×œ×—×”');
        await loadAllProducts();
      } catch (e) { showAlert(e.message, 'error'); }
    }

    // ---------------- Orders ----------------
    function addOrderItem() {
      const container = document.getElementById('order-items-container');
      const row = document.createElement('div');
      row.className = 'item-row';
      row.innerHTML = `
        <input type="text" placeholder="××–×”×” ××•×¦×¨" class="product-id-input" required />
        <input type="number" placeholder="×›××•×ª" class="quantity-input" min="1" value="1" required />
        <span class="price-display">××—×™×¨: -</span>
        <button type="button" class="remove-item-btn" onclick="removeOrderItem(this)">×”×¡×¨</button>`;
      container.appendChild(row);
      row.querySelector('.product-id-input').addEventListener('blur', function(){ updateProductPrice(this); });
    }

    function removeOrderItem(btn) {
      const container = document.getElementById('order-items-container');
      if (container.children.length > 1) btn.parentElement.remove();
      else showAlert('×—×™×™×‘ ×œ×”×™×•×ª ×œ×¤×—×•×ª ××•×¦×¨ ××—×“ ×‘×”×–×× ×”', 'error');
    }

    async function updateProductPrice(input) {
      const productId = input.value;
      const priceDisplay = input.parentElement.querySelector('.price-display');
      if (!productId) { priceDisplay.textContent = '××—×™×¨: -'; return; }
      try {
        const { data } = await apiCall(`/products/${productId}`);
        priceDisplay.textContent = `××—×™×¨: â‚ª${data.price}`;
        priceDisplay.style.color = '#28a745';
      } catch {
        priceDisplay.textContent = '××•×¦×¨ ×œ× × ××¦×';
        priceDisplay.style.color = '#dc3545';
      }
    }

    document.getElementById('order-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      const orderId = document.getElementById('order-id').value;
      const customerId = document.getElementById('order-customer-id').value;
      const items = [];
      const rows = document.querySelectorAll('#order-items-container .item-row');

      for (const r of rows) {
        const productId = r.querySelector('.product-id-input').value;
        const quantity = parseInt(r.querySelector('.quantity-input').value);
        try {
          const { data } = await apiCall(`/products/${productId}`);
          items.push({ productId, name: data.name, quantity, price: data.price });
        } catch {
          showAlert(`××•×¦×¨ ${productId} ×œ× ×§×™×™× ×‘××¢×¨×›×ª`, 'error');
          return;
        }
      }

      try {
        await apiCall('/orders', { method: 'POST', body: JSON.stringify({ order_id: orderId, customer_id: customerId, items }) });
        showAlert('×”×–×× ×” × ×•×¦×¨×” ×‘×”×¦×œ×—×”');
        this.reset();
        const container = document.getElementById('order-items-container');
        container.innerHTML = `
          <div class="item-row">
            <input type="text" placeholder="××–×”×” ××•×¦×¨" class="product-id-input" required />
            <input type="number" placeholder="×›××•×ª" class="quantity-input" min="1" value="1" required />
            <span class="price-display">××—×™×¨: -</span>
            <button type="button" class="remove-item-btn" onclick="removeOrderItem(this)">×”×¡×¨</button>
          </div>`;
        container.querySelector('.product-id-input').addEventListener('blur', function(){ updateProductPrice(this); });
      } catch (e) { showAlert(e.message, 'error'); }
    });

    async function searchOrder() {
      const id = document.getElementById('search-order').value;
      if (!id) return;
      try {
        const res = await apiCall(`/orders/${id}`);
        await displayOrders([res.data]);
      } catch { showAlert('×”×–×× ×” ×œ× × ××¦××”', 'error'); }
    }

    async function searchCustomerOrders() {
      const customerId = document.getElementById('search-customer-orders').value;
      if (!customerId) return;
      try {
        const res = await apiCall(`/orders?customer_id=${customerId}`);
        await displayOrders(res.data);
      } catch { showAlert('×œ× × ××¦××• ×”×–×× ×•×ª ×¢×‘×•×¨ ×œ×§×•×— ×–×”', 'error'); }
    }

    async function displayOrders(list) {
      const container = document.getElementById('orders-list');
      if (!list || list.length === 0) {
        container.innerHTML = '<div class="empty-state"><h3>××™×Ÿ ×”×–×× ×•×ª ×‘××¢×¨×›×ª</h3><p>×¦×•×¨ ×”×–×× ×” ×¨××©×•× ×” ×›×“×™ ×œ×”×ª×—×™×œ</p></div>';
        return;
      }
      let html = '<div>';
      for (const order of list) {
        let customerName = '×œ×§×•×— ×œ× ×™×“×•×¢';
        try {
          const res = await apiCall(`/customers/${order.customerId}`);
          customerName = res.data.name;
        } catch {}
        const orderDate = order.createdAt ? new Date(order.createdAt).toLocaleDateString('he-IL') : '-';
        html += `
          <div class="form-container" style="margin-bottom: 20px;">
            <h4>×”×–×× ×” ${order._id}</h4>
            <p><strong>×œ×§×•×—:</strong> ${customerName} (${order.customerId})</p>
            <p><strong>×¡×˜×˜×•×¡:</strong> ${getStatusText(order.status)}</p>
            <p><strong>×ª××¨×™×š:</strong> ${orderDate}</p>
            <p><strong>×¡×š ×”×›×œ:</strong> â‚ª${order.totalAmount}</p>
            <h5>×¤×¨×™×˜×™×:</h5>
            <table class="data-table">
              <thead><tr><th>××•×¦×¨</th><th>×›××•×ª</th><th>××—×™×¨ ×™×—×™×“×”</th><th>×¡×š ×”×›×œ</th></tr></thead>
              <tbody>`;
        for (const item of order.items) {
          html += `
            <tr>
              <td>${item.name} (${item.productId})</td>
              <td>${item.quantity}</td>
              <td>â‚ª${item.price}</td>
              <td>â‚ª${(item.price * item.quantity).toFixed(2)}</td>
            </tr>`;
        }
        html += `
              </tbody>
            </table>
            <div style="margin-top: 10px;">
              <button class="btn" onclick="editOrder('${order._id}')">×¢×¨×•×š ×”×–×× ×”</button>
              <button class="btn btn-info" onclick="updateOrderStatus('${order._id}')">×¢×“×›×Ÿ ×¡×˜×˜×•×¡</button>
              <button class="btn btn-danger" onclick="deleteOrder('${order._id}')">××—×§ ×”×–×× ×”</button>
            </div>
          </div>`;
      }
      html += '</div>';
      container.innerHTML = html;
    }

    function getStatusText(status) {
      const map = { paid: '×©×•×œ×', shipped: '× ×©×œ×—', cancelled: '××‘×•×˜×œ' };
      return map[status] || status || '-';
    }

    async function updateOrderStatus(id) {
      const newStatus = prompt('×¡×˜×˜×•×¡ ×—×“×© (paid/shipped/cancelled):');
      if (!newStatus || !['paid','shipped','cancelled'].includes(newStatus)) {
        showAlert('×¡×˜×˜×•×¡ ×œ× ×—×•×§×™', 'error'); return;
      }
      try {
        await apiCall(`/orders/${id}`, { method: 'PUT', body: JSON.stringify({ status: newStatus }) });
        showAlert('×¡×˜×˜×•×¡ ×”×–×× ×” ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”');
        await searchOrder();
      } catch (e) { showAlert(e.message, 'error'); }
    }

    async function deleteOrder(id) {
      if (!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ×”×–×× ×” ×–×•?')) return;
      try {
        await apiCall(`/orders/${id}`, { method: 'DELETE' });
        showAlert('×”×–×× ×” × ××—×§×” ×‘×”×¦×œ×—×”');
        document.getElementById('orders-list').innerHTML = '';
      } catch (e) { showAlert(e.message, 'error'); }
    }

    /* ======= ×¢×¨×™×›×ª ×”×–×× ×”: ×”×•×¡×¤×”/×”×¡×¨×”/×©×™× ×•×™ ×›××•×ª ×‘×œ×‘×“ ======= */
    async function editOrder(orderId) {
      const { data: order } = await apiCall(`/orders/${orderId}`);

      const container = document.getElementById('orders-list');
      const cards = [...container.querySelectorAll('.form-container')];
      const card = cards.find(div => div.querySelector('h4')?.textContent?.includes(orderId));
      if (!card) return;

      const statusOptions = [
        { val: 'paid', text: '×©×•×œ×' },
        { val: 'shipped', text: '× ×©×œ×—' },
        { val: 'cancelled', text: '××‘×•×˜×œ' }
      ];

      const rowsHtml = (order.items || []).map((it, idx) => `
        <tr data-row="${idx}" data-price="${Number(it.price)}" data-name="${it.name}" data-productid="${it.productId}">
          <td><input type="text" class="eo-product-id" value="${it.productId}" /></td>
          <td class="eo-name-cell">${it.name || ''}</td>
          <td><input type="number" class="eo-qty" value="${it.quantity}" min="1" /></td>
          <td class="eo-price-cell">â‚ª${Number(it.price).toFixed(2)}</td>
          <td class="eo-line-sum">${(it.price * it.quantity).toFixed(2)}</td>
          <td><button type="button" class="remove-item-btn" onclick="eoRemoveRow(this)">×”×¡×¨</button></td>
        </tr>
      `).join('');

      const currentStatus = order.status || 'paid';
      const statusSelect = `
        <select id="eo-status">
          ${statusOptions.map(o => `<option value="${o.val}" ${o.val === currentStatus ? 'selected' : ''}>${o.text}</option>`).join('')}
        </select>
      `;

      card.innerHTML = `
        <h4>×¢×¨×™×›×ª ×”×–×× ×” ${order._id}</h4>
        <div class="form-group">
          <label><strong>×¡×˜×˜×•×¡:</strong></label>
          ${statusSelect}
        </div>

        <div class="form-group">
          <table class="data-table" id="eo-table">
            <thead>
              <tr><th>××–×”×” ××•×¦×¨</th><th>×©×</th><th>×›××•×ª</th><th>××—×™×¨ ×™×—×™×“×”</th><th>×¡×›×•×</th><th></th></tr>
            </thead>
            <tbody>
              ${rowsHtml}
            </tbody>
          </table>
          <button type="button" class="btn btn-info" onclick="eoAddRow()">×”×•×¡×£ ××•×¦×¨</button>
        </div>

        <div class="form-group">
          <strong>×¡×š ×”×›×œ:</strong> â‚ª<span id="eo-total">0.00</span>
        </div>

        <div>
          <button class="btn" onclick="saveOrderChanges('${order._id}')">×©××•×¨ ×©×™× ×•×™×™×</button>
          <button class="btn btn-danger" onclick="searchOrder()">×‘×˜×œ</button>
        </div>
      `;

      // ×××–×™× ×™×
      card.addEventListener('input', (e) => {
        if (e.target.matches('.eo-qty')) eoRecalcTotals();
      });
      card.querySelectorAll('.eo-product-id').forEach(inp => {
        inp.addEventListener('blur', async function() {
          await eoEnsureProductDetails(this.closest('tr'));
          eoRecalcTotals();
        });
      });

      eoRecalcTotals();
    }

    function eoAddRow() {
      const tbody = document.querySelector('#eo-table tbody');
      const row = document.createElement('tr');
      row.setAttribute('data-price', '0');
      row.setAttribute('data-name', '');
      row.setAttribute('data-productid', '');
      row.innerHTML = `
        <td><input type="text" class="eo-product-id" placeholder="××–×”×” ××•×¦×¨" /></td>
        <td class="eo-name-cell"></td>
        <td><input type="number" class="eo-qty" value="1" min="1" /></td>
        <td class="eo-price-cell">â‚ª0.00</td>
        <td class="eo-line-sum">0.00</td>
        <td><button type="button" class="remove-item-btn" onclick="eoRemoveRow(this)">×”×¡×¨</button></td>
      `;
      tbody.appendChild(row);

      row.querySelector('.eo-product-id').addEventListener('blur', async function() {
        await eoEnsureProductDetails(row);
        eoRecalcTotals();
      });
      row.querySelector('.eo-qty').addEventListener('input', eoRecalcTotals);
    }

    function eoRemoveRow(btn) {
      const tbody = document.querySelector('#eo-table tbody');
      if (tbody.children.length > 1) {
        btn.closest('tr').remove();
        eoRecalcTotals();
      } else {
        showAlert('×—×™×™×‘ ×œ×”×™×•×ª ×œ×¤×—×•×ª ××•×¦×¨ ××—×“ ×‘×”×–×× ×”', 'error');
      }
    }

    function eoRecalcTotals() {
      let total = 0;
      document.querySelectorAll('#eo-table tbody tr').forEach(tr => {
        const qty = parseFloat(tr.querySelector('.eo-qty').value) || 0;
        const price = parseFloat(tr.getAttribute('data-price')) || 0;
        const line = qty * price;
        tr.querySelector('.eo-line-sum').textContent = line.toFixed(2);
        total += line;
      });
      const totalEl = document.getElementById('eo-total');
      if (totalEl) totalEl.textContent = total.toFixed(2);
    }

    // ××©×œ×™× ×¤×¨×˜×™ ××•×¦×¨ ×œ×¤×™ ××–×”×”: ××¢×“×›×Ÿ ×©×+××—×™×¨ ×œ×§×¨×™××” ×‘×œ×‘×“
    async function eoEnsureProductDetails(tr) {
      const pidInput = tr.querySelector('.eo-product-id');
      const pid = pidInput?.value?.trim();
      if (!pid) {
        tr.setAttribute('data-price', '0');
        tr.setAttribute('data-name', '');
        tr.setAttribute('data-productid', '');
        tr.querySelector('.eo-name-cell').textContent = '';
        tr.querySelector('.eo-price-cell').textContent = 'â‚ª0.00';
        return false;
      }
      try {
        const { data: p } = await apiCall(`/products/${pid}`);
        tr.setAttribute('data-price', String(p.price));
        tr.setAttribute('data-name', p.name);
        tr.setAttribute('data-productid', pid);
        tr.querySelector('.eo-name-cell').textContent = p.name;
        tr.querySelector('.eo-price-cell').textContent = `â‚ª${Number(p.price).toFixed(2)}`;
        return true;
      } catch {
        showAlert(`××•×¦×¨ ${pid} ×œ× ×§×™×™× ×‘××¢×¨×›×ª`, 'error');
        return false;
      }
    }

    async function saveOrderChanges(orderId) {
      const status = document.getElementById('eo-status').value;
      const rows = [...document.querySelectorAll('#eo-table tbody tr')];
      if (rows.length === 0) { showAlert('×™×© ×œ×›×œ×•×œ ×œ×¤×—×•×ª ×¤×¨×™×˜ ××—×“ ×‘×”×–×× ×”', 'error'); return; }

      const items = [];
      for (const tr of rows) {
        const pid = tr.querySelector('.eo-product-id').value?.trim();
        const qty = parseInt(tr.querySelector('.eo-qty').value, 10);
        if (!pid) { showAlert('×™×© ×œ×”×–×™×Ÿ ××–×”×” ××•×¦×¨ ×‘×›×œ ×©×•×¨×”', 'error'); return; }
        if (!qty || qty < 1) { showAlert('×›××•×ª ×—×™×™×‘×ª ×œ×”×™×•×ª ×œ×¤×—×•×ª 1', 'error'); return; }

        const ok = await eoEnsureProductDetails(tr);
        if (!ok) return;

        const name = tr.getAttribute('data-name') || tr.querySelector('.eo-name-cell').textContent.trim();
        const price = parseFloat(tr.getAttribute('data-price'));

        items.push({ productId: pid, name, quantity: qty, price });
      }

      try {
        await apiCall(`/orders/${orderId}`, {
          method: 'PUT',
          body: JSON.stringify({ status, items })
        });
        showAlert('×”×–×× ×” ×¢×•×“×›× ×” ×‘×”×¦×œ×—×”');
        await searchOrder();
      } catch (e) {
        showAlert(e.message, 'error');
      }
    }
    /* ======= ×¡×•×£ ×¢×¨×™×›×ª ×”×–×× ×” ======= */

    // ---------------- Analytics ----------------
    async function loadAnalytics() { await loadTotalRevenue(); await loadAnalyticsCounts(); }

    async function loadTotalRevenue() {
      try {
        const res = await apiCall('/analytics/revenue');
        const val = res?.data?.total_revenue ?? 0;
        document.getElementById('total-revenue').textContent = `â‚ª${Number(val).toFixed(2)}`;
      } catch { document.getElementById('total-revenue').textContent = '×©×’×™××”'; }
    }

    async function loadAnalyticsCounts() {
      try {
        const res = await apiCall('/analytics/counts');
        document.getElementById('total-customers').textContent = res.data.customers;
        document.getElementById('total-products').textContent = res.data.products;
      } catch {
        document.getElementById('total-customers').textContent = '×©×’×™××”';
        document.getElementById('total-products').textContent = '×©×’×™××”';
      }
    }

    async function loadTopCustomers() {
      const limit = parseInt(document.getElementById('top-customers-limit').value) || 5;
      try {
        const res = await apiCall(`/analytics/top-customers?limit=${limit}`);
        const list = res.data || [];
        const container = document.getElementById('top-customers-list');
        if (list.length === 0) { container.innerHTML = '<div class="empty-state"><p>××™×Ÿ × ×ª×•× ×™× ×œ×”×¦×’×”</p></div>'; return; }
        let html = '<table class="data-table"><thead><tr><th>×©× ×œ×§×•×—</th><th>××–×”×”</th><th>××¡×¤×¨ ×”×–×× ×•×ª</th></tr></thead><tbody>';
        for (const c of list) {
          let name = '×œ×§×•×— ×œ× ×™×“×•×¢';
          try {
            const r = await apiCall(`/customers/${c._id}`);
            name = r.data.name;
          } catch {}
          html += `<tr><td>${name}</td><td>${c._id}</td><td>${c.ordersCount}</td></tr>`;
        }
        html += '</tbody></table>';
        container.innerHTML = html;
      } catch {
        document.getElementById('top-customers-list').innerHTML = '<div class="empty-state"><p>×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×</p></div>';
      }
    }

    async function loadTopProduct() {
      try {
        const res = await apiCall('/analytics/top-products');
        const top = res.data;
        const container = document.getElementById('top-product-info');
        if (!top) { container.innerHTML = '<div class="empty-state"><p>××™×Ÿ × ×ª×•× ×™× ×œ×”×¦×’×”</p></div>'; return; }
        let name = '××•×¦×¨ ×œ× ×™×“×•×¢', category = '-';
        try {
          const pr = await apiCall(`/products/${top._id}`);
          name = pr.data.name; category = pr.data.category;
        } catch {}
        container.innerHTML = `
          <div class="stat-card">
            <h4>${name}</h4>
            <p><strong>××–×”×”:</strong> ${top._id}</p>
            <p><strong>×§×˜×’×•×¨×™×”:</strong> ${category}</p>
            <p><strong>×™×—×™×“×•×ª ×©× ××›×¨×•:</strong> ${top.totalSold}</p>
          </div>`;
      } catch {
        document.getElementById('top-product-info').innerHTML = '<div class="empty-state"><p>×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×</p></div>';
      }
    }

    // Initial bind
    document.addEventListener('DOMContentLoaded', function () {
      const input = document.querySelector('.product-id-input');
      if (input) input.addEventListener('blur', function(){ updateProductPrice(this); });
    });
  </script>
</body>
</html>
